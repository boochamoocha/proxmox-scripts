# Задание: Скрипт для автоматической установки Avahi в LXC-контейнер на Proxmox

## Цель

Написать Bash-скрипт для хост-системы Proxmox, который автоматизирует процесс установки и настройки службы `avahi-daemon` внутри указанного LXC-контейнера. Это позволит обращаться к контейнеру из локальной сети по его имени с суффиксом `.local` (например, `ubuntu-server.local`).

## Ключевые требования

1.  **Принятие аргумента:** Скрипт должен принимать один обязательный аргумент — **ID** LXC-контейнера.

      * Если ID не указан, скрипт должен выводить ошибку и инструкцию по использованию.

2.  **Проверка контейнера:** Перед выполнением основных действий скрипт должен убедиться, что:

      * Контейнер с указанным ID существует.
      * Контейнер находится в состоянии `running` (запущен).
      * Если одно из условий не выполнено, вывести соответствующую ошибку.

3.  **Автоопределение ОС:** Скрипт должен автоматически определять дистрибутив Linux внутри контейнера. Необходимо реализовать поддержку как минимум для:

      * **Debian-based** систем (Debian, Ubuntu).
      * **Alpine Linux**.

4.  **Управление пакетами:** В зависимости от определенной ОС, скрипт должен использовать соответствующий пакетный менеджер для установки Avahi:

      * Для Debian/Ubuntu: `apt install avahi-daemon avahi-utils`. Установка должна проходить в неинтерактивном режиме (`-y`).
      * Для Alpine: `apk add avahi avahi-tools`.

5.  **Настройка сервиса:**

      * Скрипт должен добавить сервис `avahi-daemon` в автозагрузку и запустить его, используя соответствующую систему инициализации (`systemd` для Debian, `OpenRC` для Alpine).
      * **Обязательно:** Для `systemd` (Debian/Ubuntu) необходимо применить исправление для работы в LXC. Создать `override`-файл для сервиса (`/etc/systemd/system/avahi-daemon.service.d/lxc.conf`), который добавляет флаг `--no-rlimits` к команде запуска.
      * После внесения изменений в конфигурацию `systemd` необходимо выполнить `daemon-reload` и перезапустить сервис.

6.  **Обработка ошибок:** При возникновении ошибок скрипт должен выполнять откат изменений:

      * Удаление установленных пакетов при ошибке установки или настройки.
      * Отключение и остановка службы при ошибке в процессе настройки.
      * Удаление созданных конфигурационных файлов (systemd override).
      
7.  **Логирование:** Вывод в консоль должен быть достаточно информативным:

      * Информативные сообщения о ходе выполнения.
      * Сообщения об ошибках с подробностями.
      * Подтверждения успешного выполнения этапов.

8.  **Проверка работы:** После установки и настройки необходимо проверить работоспособность Avahi:

      * Проверка статуса службы avahi-daemon.
      * Тестирование резолвинга имени контейнера через `.local` домен.

9.  **Вывод информации:** Скрипт должен информировать пользователя о ходе выполнения:

      * О начале работы и цели (ID контейнера).
      * Об обнаруженном типе ОС.
      * О завершении установки пакетов.
      * В конце вывести сообщение об успешном завершении и напомнить пользователю, по какому адресу (`<hostname>.local`) теперь доступен контейнер.

10. **Исполнение команд:** Все команды внутри контейнера должны выполняться с хоста Proxmox с помощью утилиты `pct exec`.

## Пример использования

Скрипт должен запускаться из командной строки хоста Proxmox следующим образом:

```bash
./install_avahi_lxc.sh 101
```

## Итог

Финальным продуктом должен быть один самодостаточный Bash-скрипт, который выполняет все перечисленные выше требования.