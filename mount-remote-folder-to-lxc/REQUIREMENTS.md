# Требования к скрипту монтирования сетевых шар в LXC контейнеры

## Основная задача
Обеспечить быстрый и удобный способ предоставления доступа к сетевым шарам (NFS/CIFS) и локальным директориям хоста в LXC контейнеры Proxmox с различными уровнями доступа.

## Анализ подходов к предоставлению доступа к сетевым директориям

### Подход 1: Монтирование на хосте + Bind Mount в контейнер

**Механизм:**
1. Сетевая шара монтируется на хост Proxmox (`mount -t nfs/cifs`)
2. Смонтированная директория хоста пробрасывается в контейнер через LXC bind mount
3. Конфигурация: `mp0: /mnt/host-nfs,mp=/mnt/container-data`

**Плюсы:**
- ✅ Централизованное управление сетевыми подключениями на хосте
- ✅ Одно сетевое подключение может использоваться несколькими контейнерами
- ✅ Проще отладка сетевых проблем (все на хосте)
- ✅ Меньше нагрузки на сеть (один TCP connection)
- ✅ Единая точка аутентификации CIFS/NFS
- ✅ Автоматическое переподключение на уровне хоста
- ✅ Проще резервное копирование и снапшоты (данные физически на хосте)

**Минусы:**
- ❌ Зависимость контейнеров от состояния хоста
- ❌ Если падает монтирование на хосте - падает во всех контейнерах
- ❌ Сложнее изоляция контейнеров (общие mount points)
- ❌ Требует администрирования на уровне хоста

### Подход 2: Прямое монтирование в контейнере

**Механизм:**
1. Установка пакетов NFS/CIFS внутри контейнера
2. Монтирование сетевой шары напрямую в контейнере
3. Конфигурация в `/etc/fstab` контейнера или systemd mount units

**Плюсы:**
- ✅ Полная изоляция контейнеров
- ✅ Независимость от конфигурации хоста
- ✅ Гибкость настройки для каждого контейнера
- ✅ Разные учетные данные для разных контейнеров
- ✅ Проще миграция контейнеров между хостами

**Минусы:**
- ❌ Множественные сетевые подключения к одной шаре
- ❌ Больше потребление ресурсов (RAM, network connections)
- ❌ Сложнее централизованное управление
- ❌ Нужно устанавливать пакеты в каждый контейнер
- ❌ Сложнее отладка проблем с сетью
- ❌ Проблемы с правами доступа (UID/GID mapping)

### Подход 3: Гибридный подход

**Механизм:**
- Критичные шары монтируются на хосте (централизованно)
- Специфичные шары монтируются в контейнерах (изолированно)
- Выбор подхода в зависимости от use case

## Рекомендуемая архитектура

### Для продакшен окружения:
**Подход 1 (хост + bind mount)** - предпочтительный по следующим причинам:

1. **Reliability**: Один point of failure лучше чем множественные
2. **Performance**: Меньше сетевых соединений и overhead
3. **Management**: Централизованные логи, мониторинг, backup
4. **Security**: Единая точка аутентификации и контроля доступа

### Для разработки/тестирования:
**Подход 2 (прямое монтирование)** может быть предпочтительнее для:
- Тестирования разных конфигураций
- Изоляции экспериментальных окружений
- Случаев, когда нужны разные версии клиентов NFS/CIFS

## Функциональные требования

### 1. Поддержка типов монтирования
- **NFS** - сетевые NFS шары (приоритет: хост + bind mount)
- **CIFS/SMB** - сетевые CIFS шары (приоритет: хост + bind mount)  
- **Mounted** - уже доступные директории хоста (только bind mount)

### 2. Режимы работы
- **Host-managed** (по умолчанию): монтирование на хосте + bind mount
- **Container-direct**: прямое монтирование в контейнере (опционально)

### 3. Уровни доступа
- **Read-Only (ro)** - только чтение
- **Read-Write (rw)** - чтение и запись

### 4. Интерактивный ввод параметров
- ID контейнера
- Режим работы (host-managed/container-direct)
- Тип источника данных (nfs/cifs/mounted)
- Источник:
  - NFS: `192.168.1.10:/media/nfs`
  - CIFS: `192.168.1.10/Movies`
  - Mounted: `/mnt/dsm/movies`
- Путь монтирования на хосте (только для NFS/CIFS в host-managed режиме)
- Путь в контейнере
- Уровень доступа (ro/rw)
- Для CIFS: учетные данные

**Особенности для типа Mounted:**
- Не требует ввода "пути монтирования на хосте" - используется напрямую исходный путь
- Доступен только в host-managed режиме (container-direct не поддерживается)
- Результат: прямой bind mount уже существующей директории в контейнер

### 5. Автоматизация процесса
- Проверка существования контейнера
- Автоматический поиск свободного mpX индекса (mp0-mp31)
- Установка необходимых пакетов (на хосте или в контейнере)
- Создание директорий на хосте и в контейнере
- Добавление корректной конфигурации в LXC
- Для container-direct: настройка автомонтирования в контейнере
- Перезапуск контейнера для применения изменений
- Проверка успешности монтирования

## Технические требования

### 1. Исправление текущих проблем
- ✅ Исправить некорректный shebang (убрать лишний символ "А")
- ✅ Добавить валидацию пустых значений при вводе
- ✅ Улучшить обработку ошибок
- ✅ Исправить проблемы с интерактивным вводом при pipe execution
- ✅ Добавить TTY detection и fallback механизмы
- ✅ **Упростить интерфейс для типа Mounted**: убрать избыточный запрос "пути монтирования на хосте"
- ✅ **Переименовать тип с "local" на "mounted"**: более точно отражает суть - уже доступные директории

### 2. Поддержка режимов работы
- **Host-managed режим**: 
  - Монтирование на хост
  - Bind mount в контейнер через LXC конфиг
- **Container-direct режим**:
  - Установка пакетов в контейнер
  - Настройка автомонтирования в контейнере
  - Конфигурация fstab или systemd

### 3. Конфигурация доступа
- Для **Read-Only**: добавлять параметр `ro=1` в LXC конфиг
- Для **Read-Write**: использовать стандартное поведение
- Примеры конфигураций:
  ```bash
  # Host-managed
  mp0: /mnt/host-folder,mp=/mnt/container-folder
  mp1: /mnt/host-folder,mp=/mnt/container-folder,ro=1
  
  # Container-direct (в fstab контейнера)
  //192.168.1.10/share /mnt/data cifs username=user,password=pass 0 0
  ```

## Примеры использования

### Сценарий 1: NFS шара через хост (рекомендуемый)
```
Режим: host-managed
ID контейнера: 102
Тип: nfs
Источник: 192.168.1.10:/media/movies
Хост: /mnt/nfs-movies
Контейнер: /mnt/movies
Доступ: ro
```

### Сценарий 2: Прямое CIFS в контейнере
```
Режим: container-direct
ID контейнера: 103
Тип: cifs  
Источник: 192.168.1.20/personal
Контейнер: /mnt/personal
Доступ: rw
Пользователь: john
Пароль: [скрытый ввод]
```

### Сценарий 3: Уже доступная директория bind mount
```
Режим: host-managed (единственный вариант)
ID контейнера: 104
Тип: mounted
Источник: /mnt/dsm/data
Контейнер: /mnt/data
Доступ: rw

Примечание: Путь монтирования на хосте не запрашивается - используется исходная директория
Результат: mp0: /mnt/dsm/data,mp=/mnt/data
```

## Критерии приемки

1. ✅ Скрипт поддерживает оба режима работы
2. ✅ По умолчанию использует host-managed режим
3. ✅ Корректно обрабатывает все типы монтирования
4. ✅ Поддерживает уровни доступа (ro/rw)
5. ✅ Проверяет результат монтирования в обоих режимах
6. ✅ Предоставляет понятные сообщения об ошибках
7. ✅ Не нарушает существующие конфигурации
8. ✅ Корректно работает при прямом запуске и через pipe
9. ✅ Предоставляет четкие инструкции при проблемах с TTY

## Безопасность

- Проверка существования контейнера перед внесением изменений
- Валидация путей для предотвращения инъекций  
- Безопасное хранение/передача CIFS паролей
- Проверка прав доступа к конфигурационным файлам
- Изоляция учетных данных между контейнерами (для container-direct)
- Безопасный интерактивный ввод с использованием TTY
- Защита от выполнения в небезопасных средах без TTY

## Совместимость и запуск

### Методы запуска
1. **Локальный запуск (рекомендуемый)**: 
   - Скачивание и выполнение локально
   - Полная поддержка интерактивного ввода
   - Максимальная совместимость

2. **Pipe execution**: 
   - Попытка выполнения через curl/wget pipe
   - Автоматическое определение доступности TTY
   - Fallback с инструкциями при невозможности интерактивного ввода

### Обработка ошибок ввода
- Проверка доступности TTY перед началом интерактивного ввода
- Четкие сообщения об ошибках с инструкциями по решению
- Автоматическое предложение альтернативных методов запуска
- Валидация всех пользовательских данных перед обработкой

### Пользовательский опыт
- Понятные сообщения об ошибках на русском языке
- Пошаговые инструкции для решения проблем
- Интуитивно понятный интерфейс с numbered choices
- Подробная итоговая сводка выполненных операций